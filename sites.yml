---
# ------------------------------------------------------------------------------
# Builds my XEN Server Farm from scratch
#
# This script runs as root on victoria.yaocm.id.au using ssh configuration
#   entry called 'victoria_root'.
# ------------------------------------------------------------------------------

- hosts:                victoria_root

  tasks:
  
  # ------------------- Add Bridge
  #                     Rather than using nmcli, I have hard-coded the interface
  #                     configuration files.
  
  - name:               "Add bridges"
    script:
      chdir:            /etc/sysconfig/network-scripts
      cmd:              "scripts/{{ item.script }}"
      creates:          "/etc/sysconfig/network-scripts/{{ item.creates }}"
      executable:       /bin/bash
    with_items:
      -                 { script: "create_bridges.sh", creates: "ifcfg-xenbr0" }
      -                 { script: "create_subif_on_eth1.sh", creates: "ifcfg-eth1:1" }
    register:           add_bridges
    notify:             "restart network"

  - name:               "Display output from add bridges"
    debug:
      var:              add_bridges.stdout_lines
    when:               add_bridges.stdout_lines is defined

  - name:               "Create bridge on eth0"
    blockinfile:
      insertafter:      EOF
      path:             /etc/sysconfig/network-scripts/ifcfg-eth0
      block:            |
        # Bridge 
        BRIDGE="xenbr0" 
    notify:             "restart network"

  # ------------------- Create Repository

  - name:               "Create Repository"
    file:
      path:             "/OVS/{{ item }}"
      state:            directory
    with_items:
      -                 iso_pool
      -                 seed_pool
      -                 running_pool

  # ------------------- Handlers
  
  handlers:
  
  - name:               "restart network"
    service:
      name:             network
      state:            restarted
...
